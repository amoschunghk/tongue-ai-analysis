<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI 舌診健康分析系統</title>
<style>
    body {
        font-family: "Microsoft JhengHei", sans-serif;
        background: linear-gradient(135deg, #ffecd2, #fcb69f);
        text-align: center;
        padding: 20px;
        color: #333;
    }
    .container {
        max-width: 500px;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        margin: auto;
    }
    img { max-width: 100%; border-radius: 10px; margin-top: 10px; }
    #analysis { text-align: left; margin-top: 15px; background: #f7f7f7; padding: 10px; border-radius: 10px; }
</style>
</head>
<body>
<div class="container">
    <h2>AI 舌診健康分析系統</h2>
    <input type="file" accept="image/*" id="upload">
    <img id="preview" style="display:none;">
    <div id="analysis" style="display:none;"></div>
</div>
<script>
const API_URL = "https://dainty-semifreddo-ff893f.netlify.app/.netlify/functions/tongue-analysis";
const POLL_INTERVAL = 2000; // 輪詢間隔 2 秒

// 輪詢結果函數
async function pollResult(predictionId) {
    const pollUrl = `${API_URL}?id=${predictionId}`;
    
    while (true) {
        try {
            await new Promise(resolve => setTimeout(resolve, POLL_INTERVAL));
            
            const response = await fetch(pollUrl);
            const data = await response.json();
            
            if (data.status === "succeeded") {
                document.getElementById("analysis").innerHTML = "<h3>健康分析報告</h3><p>" + data.result + "</p>";
                return;
            } else if (data.status === "failed") {
                document.getElementById("analysis").innerHTML = "<p>分析失敗: " + (data.error || "模型處理錯誤") + "</p>";
                return;
            } else {
                document.getElementById("analysis").innerHTML = "<p>AI 分析中... 請耐心等待</p>";
            }
        } catch (error) {
            document.getElementById("analysis").innerHTML = "<p>輪詢錯誤: " + error.message + "</p>";
            return;
        }
    }
}

document.getElementById("upload").addEventListener("change", async function(){
    const file = this.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async function(e){
        document.getElementById("preview").src = e.target.result;
        document.getElementById("preview").style.display = "block";
        document.getElementById("analysis").innerHTML = "AI 分析中...";
        document.getElementById("analysis").style.display = "block";

        try {
            const res = await fetch(API_URL, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ image: e.target.result })
            });
            const data = await res.json();
            
            if (res.status === 202) {
                // 處理中，需要輪詢結果
                document.getElementById("analysis").innerHTML = "<p>" + data.message + "</p>";
                await pollResult(data.id);
            } else if (res.status === 200) {
                // 直接返回結果
                document.getElementById("analysis").innerHTML = "<h3>健康分析報告</h3><p>" + data.result + "</p>";
            } else {
                // 處理錯誤
                document.getElementById("analysis").innerHTML = "<p>分析失敗: " + (data.error || "未知錯誤") + "</p>";
            }
        } catch (error) {
            document.getElementById("analysis").innerHTML = "<p>系統錯誤: " + error.message + "</p>";
        }
    }
    reader.readAsDataURL(file);
});
</script>
</body>
</html>
